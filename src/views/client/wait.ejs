<%- include('../partials/client/header') %>
<main>
  <div
    class="wrapper d-flex align-items-center justify-content-center"
    style="height: 85vh"
  >
    <div
      class="container d-flex flex-column align-items-center"
      style="margin-top: -140px"
    >
      <section class="wait text-center">
        <h2>
          Welcome, Tim <strong><%= namatim %>,</strong>
        </h2>
        <h2 id="credit"></h2>
      </section>
      <section class="quiz" style="display: none">
        <div id="questionIndex"></div>
        <div id="question"></div>
        <div class="row justify-content-center">
          <div class="col-md-6">
            <div id="options"></div>
          </div>
        </div>
      </section>
      <section class="end" style="display: none">
        <div class="congrats"></div>
      </section>
    </div>
  </div>
</main>

<script>
  var namatim = "<%= namatim %>";
  let fund = 1000000;
  let question;

  const formatter = new Intl.NumberFormat("en-SG", {
    style: "currency",
    currency: "SGD",
    currencyDisplay: "symbol",
  });

  document.getElementById(
    "credit"
  ).innerHTML = `<p>Congratulations! You've got</p><br> <h1 style="font-weight: 650; font-size: 50px; color: #38D200;
"><strong>S${formatter.format(
    fund
  )}</strong> </h1><br><p>Initial Balance</p>`;

  const socket = io("http://localhost:3000", {
    query: {
      userId: namatim, // ID tetap
      role: "user",
    },
  });

  const submitAnswer = (i) => {
    const optionsDiv = document.getElementById("options");

    let btn = optionsDiv.querySelectorAll("button");

    btn.forEach((button) => {
      button.classList.add("disabled");
    });

    const selectedBtn = event.target;
    selectedBtn.classList.remove("btn-secondary");
    selectedBtn.classList.add("btn-light", "text-primary", "border-primary");

    fund += fund * (i / 100);
    console.log(
      `Fund after question: S${formatter.format(
        fund
      )} (calculated from ${i}% adjustment)`
    );
    socket.emit("vote", { teamName: namatim, option: i });
    socket.emit("updatefund", { teamName: namatim, amount: fund });
  };

  socket.on("updateTeams", (Teams) => {
    fund = Teams[namatim].fund;
  });

  socket.on("question", (data) => {
    const questionIndexDiv = document.getElementById("questionIndex");
    const questionDiv = document.getElementById("question");

    questionIndexDiv.innerText = `(QUESTION : ${data.id})`;
    questionIndexDiv.classList.add("h3", "text-center");

    questionDiv.innerText = data.question;
    questionDiv.classList.add("h2", "text-center");

    question = data;

    const optionsDiv = document.getElementById("options");
    optionsDiv.innerHTML = "";
    optionsDiv.classList.add(
      "d-flex",
      "flex-column",
      "gap-3",
      "align-items-center",
      "mt-3"
    );

    data.options.forEach((opt, i) => {
      const btn = document.createElement("button");
      btn.innerText = opt.text; // Ambil teks dari objek option
      btn.onclick = () => submitAnswer(opt.value);

      // Tambahkan class Bootstrap ke tombol
      btn.classList.add("btn", "btn-primary", "w-100");

      // Tambahkan tombol ke dalam optionsDiv
      optionsDiv.appendChild(btn);
    });
  });

  socket.on("end", () => {
    const quizElement = document.querySelector(".quiz");
    const endElement = document.querySelector(".end");
    const congratsElement = document.querySelector(".congrats");

    quizElement.style.display = "none";
    endElement.style.display = "block";

    congratsElement.classList.add("h2", "text-center");
    congratsElement.innerText = `Quiz was ended, your final fund is S${formatter.format(
      fund
    )}`;
  });

  socket.on("quizStarted", () => {
    console.log("Event quizStarted diterima!");
    const waitElement = document.querySelector(".wait");
    const quizElement = document.querySelector(".quiz");

    if (waitElement) {
      console.log("Menyembunyikan wait...");
      waitElement.classList.remove("d-flex");
      waitElement.classList.add("d-none");
    } else {
      console.log("Elemen .wait tidak ditemukan!");
    }

    if (quizElement) {
      console.log("Menampilkan quiz...");
      quizElement.style.display = "block";
    } else {
      console.log("Elemen .quiz tidak ditemukan!");
    }
  });

</script>

<%- include('../partials/client/footer') %>
