<%- include('../partials/led/header') %>
<main>
  <div class="container mt-5">
    <section class="wait">
      <div class="row">
        <div class="col-md-6">
          <h1 class="text-white">Get Ready for Portfolio Game</h1>
          <p class="text-white">
            Please scan or type link on the table and enter your Team Name
          </p>
        </div>
        <div class="col-md-6">
          <h2 class="text-center text-white">Welcome Team</h2>
          <div id="list-tim-join" class="row g-3 justify-content-center"></div>
        </div>
      </div>
    </section>
    <section class="quiz">
      <div id="question" class="text-center h2 text-white"></div>
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div id="options" class="row mt-3"></div>
        </div>
      </div>
    </section>
    <section class="leaderboard" style="display: none">
      <div class="row justify-content-center">
        <div class="col-md-8">
          <h1 class="text-white">Leaderboard</h1>
          <div class="card shadow rounded">
            <div class="card-body">
              <div class="table-responsif mt-3">
                <table class="table">
                  <tbody id="list-tim"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<script>
  let question;
  let currentIndex = 0;
  const nextQuestion = (idx) => {
    socket.emit("getQuestion", idx);
  };

  const socket = io("http://localhost:3000", {
    query: {
      userId: "host", // ID tetap
      role: "host",
    },
  });

  const formatter = new Intl.NumberFormat("en-SG", {
    style: "currency",
    currency: "SGD",
    currencyDisplay: "symbol",
  });

  socket.on("TeamLeave", (namatim) => {
    console.log(`${namatim} left`);

    fetch("/updatetim", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ teamName: namatim }),
    })
      .then((response) => response.json())
      .then((data) => console.log(data))
      .catch((error) => console.error("Error:", error));
  });

  socket.on("questioninLeaderboard", (data) => {
    document.querySelector(".wait").style.display = "none";
    document.getElementById("question").innerText = data.question;
    const optionsDiv = document.getElementById("options");
    optionsDiv.innerHTML = "";

    data.options.forEach((opt) => {
      const optionCard = document.createElement("div");
      optionCard.className = "col-md-6 mb-2";
      optionCard.innerHTML = `
      <div class="card">
        <div class="card-body text-center">
          <h5>${opt.text}</h5>
          <div id="votes-${opt.value}" class="mt-2 text-success">Votes: 0</div>
        </div>
      </div>`;
      optionsDiv.appendChild(optionCard);
    });
  });

  socket.on("updateVotes", (votes) => {
    Object.entries(votes).forEach(([optionValue, count]) => {
      const voteElem = document.getElementById(`votes-${optionValue}`);
      if (voteElem) voteElem.innerText = `Votes: ${count}`;
    });
  });

  socket.on("endinLeaderboard", () => {
    document.querySelector(".quiz").style.display = "none";
    document.querySelector(".leaderboard").style.display = "block";
  });

  socket.on("updateTeams", (Teams) => {
    const listTim = document.getElementById("list-tim");
    listTim.innerHTML = "";
    Object.values(Teams)
      .sort((a, b) => b.fund - a.fund)
      .forEach((team, index) => {
        listTim.innerHTML += `<tr>
      <td>${index + 1}</td>
      <td>${team.name}</td>
      <td>${team.fund.toLocaleString("id-ID")}</td>
    </tr>`;
      });
  });

  socket.on("updateTeams", (Teams) => {
    console.log("Updated teams:", Teams);
    const listTim = document.getElementById("list-tim-join");
    listTim.innerHTML = "";

    for (let id in Teams) {
      const div = document.createElement("div");
      div.className = "col-md-4 text-center p-2";
      div.setAttribute("data-team", Teams[id].name);
      div.innerHTML = `<div class="p-2 border rounded bg-light" style="font-weight: 600; font-size: 20px;">${Teams[id].name}</div>`;
      listTim.appendChild(div);
    }
  });

  socket.on("resetData", () => {
    console.log("reset Leaderboard");
    
    // Reset UI elements, e.g., hide quiz and leaderboard, show waiting screen
    document.querySelector(".quiz").style.display = "none";
    document.querySelector(".leaderboard").style.display = "none";
    document.querySelector(".wait").style.display = "block"; // Show waiting page again

    // Clear team list or other necessary elements
    const listTim = document.getElementById("list-tim");
    const listTimJoin = document.getElementById("list-tim-join");
    listTim.innerHTML = ""; // Clear team list
    listTimJoin.innerHTML = ""; // Clear team list
  });
</script>

<%- include('../partials/led/footer') %>
